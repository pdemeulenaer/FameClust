


 ! Compilation: gfortran -O3 -march=native -ffast-math -funroll-loops -mcmodel=medium Module_Linear_Algebra.f90 Module_lecture.f90 debug_program.f90 -o debug_program.exe -lblas -llapack -lm
 !
 ! Example: time ./debug_program.exe InputFameClustNEW_UBVRI_Z01900_M400 1 10 n00


 Program main
 use Lecture_module_fortran
 use Linear_algebra_module
 implicit none

 !!!!!!!!!!!!!!!!
 !INITIALISATIONS
 !!!!!!!!!!!!!!!!


 real(4), allocatable :: A_lambda_filters_selected(:),observations(:,:)
 real(4), allocatable :: observations_initial(:,:)
 real(4) :: age, mass, Z, Ebv
 real(4) :: distance_modulus
 real(4) :: lambda, lambda_f_MW, lambda_f_LMC
 real(4) :: data_input(1:52),data_sigma_input(1:52),xx
 real(4) :: Z_selected, Rv
 real(4), allocatable :: observations_sigma(:,:)

 real(4), allocatable :: Grid_nodes_means(:,:,:,:)
 real(4), allocatable :: Grid_nodes_means_reddened(:,:,:,:,:)
 real(4), allocatable :: Grid_nodes_covariances(:,:,:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_INV(:,:,:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_DET_inv(:,:,:)
 real(4), allocatable :: Grid_nodes_weights(:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_M(:,:,:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_M_INV(:,:,:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_M_DET(:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_M_DET_inv(:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_obs_LIST(:,:,:)
 real(4), allocatable :: Grid_nodes_covariances_obs(:,:)
 real(4), allocatable :: solution(:,:)

 real(4), allocatable :: observation(:)
 real(4), allocatable :: proba_node_3D(:,:,:)
 real(4), allocatable :: normalization_here(:,:,:)
 real(4), allocatable :: x_minus_mu(:,:,:,:,:)

 real(4) :: normalization
 integer, dimension(3) :: max_proba_indexes

 !real(4) :: Amplitude,xxx,mu,sigma_MagLim,MagLim_Factor,smooth_gaussian_step_scalar
 real(4) :: Min_extinction, Max_extinction!, proba_model_oneFilter
 real(4) :: sigma_filter_automatic!, proba_model
 real(4) :: a_sigma, b_sigma, c_sigma
 integer, allocatable :: observations_MagLim(:,:)
 integer, allocatable ::  filters_selected_index(:)
 integer, allocatable :: Cluster_ID(:)
 integer :: filter_ID !,Ext_limit1,Ext_limit2
 integer :: ff,ii,jj,a,m,zz,Ext, aa,mm, number_clusters
 integer :: list, number_cluster_observed
 integer :: choice_extinction
 integer :: number_filters, choice_filters, choice_extinction_law
 integer :: filters(1:52) !SHOULD BE IN ALLOCATABLE but conflict with input file reading
 integer :: number_begin, number_end, app_or_abs
 integer :: number_nodes_age,number_nodes_mass,number_models_per_node,number_of_filters_in_grid
 integer :: choice_RealClusters_or_ArtificialTest, choice_output_NodeFiles
 integer :: Ext_min,Ext_max,Ext_bidon
 character(len=50) :: arg !,file_name
 character(len=200) :: InputFile_Name
 character(len=50) :: age_indice,mass_indice,Z_indice,Ebv_indice
 character(len=50) :: jj_char
 character(len=300) :: File_information_filters_and_ExtCurve
 character(len=300) :: file_out_cluster, file_out_cluster_f90
 character(len=300) :: file_observed_clusters
 character(len=300) :: file_out_cluster_node
 character(len=300) :: Grid_path1,Grid_path2
 CHARACTER(len=3) :: Z_indice_selected
 character(len=300) :: path_GMM_bin_file
 integer, parameter :: components_number = 10
 real(4), dimension(1:components_number,1:29) :: means
 real(4), dimension(1:components_number,1:29,1:29) :: covariances
 real(4), dimension(1:components_number) :: weights

 integer :: N_bin_all_nodes            != 7171000 !4331000 !5041000 !4331000 !5751000 !4331000 !106253000
 integer, allocatable :: bidule(:)

 write(*,*)
 CALL system('date')

 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 !GETTING THE ARGUMENTS OF THE COMMAND-LINE 
 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 call getarg(1, InputFile_Name)
 InputFile_Name = '/home/philippe/Desktop/Discrete_models_comparaison_jtao&
	&/SC_Parameters_20/'//trim(adjustl(adjustr(InputFile_Name))) 
 call getarg(2, arg) 
 read (arg,'(I10)') number_begin
 call getarg(3, arg)
 read (arg,'(I10)') number_end
 call getarg(4, Z_indice_selected) 
 call age_mass_Z_December_Inverse(aa,mm,zz,Ext,age,mass,Z,Ebv, Z_indice_selected)
 call age_mass_Z_December(a,m,zz,Ext, age, mass, Z_selected, Ebv, age_indice, mass_indice, Z_indice, Ebv_indice)
 write(*,*)Z_indice,zz,Z_selected

 number_clusters = number_end - number_begin + 1  


 !# -------------------------
 !# Loading of the input file
 !# -------------------------
 filters(:) = 0
 open(unit=10,file=InputFile_Name)
 READ(10,*)
 READ(10,*)
 READ(10,*)number_filters
 READ(10,*)
 allocate(filters_selected_index(1:number_filters),A_lambda_filters_selected(1:number_filters))
 DO ii = 1,number_filters
  READ(10,*) choice_filters
  filters_selected_index(ii)=choice_filters
  filters(choice_filters) = 1
 ENDDO
 READ(10,*)
 READ(10,*) distance_modulus  		!M33: 24.54 (McConnachie2004;2005) !M31: 24.47 (Narbutis2008)
 READ(10,*)
 READ(10,*) app_or_abs			!apparent or absolute magnitude? (1/2)
 READ(10,*)
 READ(10,*) file_observed_clusters	!name of the file containing the observed clusters
 READ(10,*)
 READ(10,*) number_cluster_observed	!How many clusters are there in your file
 READ(10,*)
 READ(10,*) choice_extinction		!cluster(s) studied extincted or not ? (1/2)
 READ(10,*)
 READ(10,*) choice_extinction_law
 READ(10,*)
 READ(10,'(a)') file_out_cluster  	!This format '(a)' because of the slashes in the name of directories
 READ(10,*)
 write(*,*) file_out_cluster		!Path where to store the output files
 READ(10,'(a)') Grid_path1
 READ(10,'(a)') Grid_path2
 READ(10,*)
 READ(10,*) number_nodes_age,number_nodes_mass
 READ(10,*)
 READ(10,*) number_models_per_node
 READ(10,*)
 READ(10,*) number_of_filters_in_grid
 READ(10,*)
 READ(10,'(a)') File_information_filters_and_ExtCurve
 READ(10,*)
 READ(10,*) Min_extinction, Max_extinction
 READ(10,*)
 READ(10,*) choice_RealClusters_or_ArtificialTest
 READ(10,*)
 READ(10,*) choice_output_NodeFiles
 close(10)


 !# -----------------------------------
 !# Allocations of the different tables
 !# -----------------------------------

 !?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
 !N_bin_all_nodes = number_nodes_age * number_nodes_mass * number_models_per_node 
 !ALLOCATE(bidule(N_bin_all_nodes))    !????? STRANGELY, IF I REMOVE THIS, IT BUGS!  ????????? (but not useful at all!)
 !?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

 ALLOCATE(Cluster_ID(1:number_cluster_observed))

 ALLOCATE(Grid_nodes_means(number_nodes_age,number_nodes_mass,components_number,number_filters))
 !ALLOCATE(Grid_nodes_means_reddened(121,number_nodes_age,number_nodes_mass,components_number,number_filters))
 ALLOCATE(Grid_nodes_covariances(number_nodes_age,number_nodes_mass,components_number,number_filters,number_filters))
 !ALLOCATE(Grid_nodes_covariances_INV(number_nodes_age,number_nodes_mass,components_number,number_filters,number_filters))
 !ALLOCATE(Grid_nodes_covariances_DET_inv(number_nodes_age,number_nodes_mass,components_number))
 ALLOCATE(Grid_nodes_weights(number_nodes_age,number_nodes_mass,components_number))





 !# -----------------------------------------------
 !# Loading of the grid of models (from .bin files)
 !# -----------------------------------------------
 write(*,*)
 write(*,*) '--------------------------------------------------------'
 write(*,*) 'Loading of the grid of models'
 write(*,*) '--------------------------------------------------------'

 Grid_nodes_means = 0.
 !Grid_nodes_means_reddened = 0.
 Grid_nodes_weights = 0.
 Grid_nodes_covariances = 0.
 Ext_bidon = 1

 path_GMM_bin_file = '/home/philippe/Desktop/Discrete_models_comparaison_jtao/'
 path_GMM_bin_file = trim(path_GMM_bin_file) // 'Grid_FRS_allZ_Kroupa_generated/NPZ_in_BIN_files/n00/'
 write(*,*) path_GMM_bin_file

 Do aa = 1, number_nodes_age !71		!Loop on the age. 
  Do mm = 1, number_nodes_mass  !101		!Loop on the mass. 

   !write(*,*)'flag 0', aa,mm

   call age_mass_Z_December(aa,mm,zz,Ext_bidon,age,mass,Z,Ebv,age_indice,mass_indice,Z_indice,Ebv_indice)

   !write(*,*)'flag 0.1', aa,mm

   !READING BINARY GRID
   call Lecture_GMM_BIN_GRID_March2016(path_GMM_bin_file,means,covariances,weights,&
     	& age_indice,mass_indice,Z_indice,components_number)

   !write(*,*)'flag 0.2', aa,mm

   !#Extracting the means, covariances and weights for the good filters, in grids
   do ii = 1,components_number
    Grid_nodes_means(aa,mm,ii,:)         = means(ii,                         &
      & filters_selected_index(1):filters_selected_index(1)+number_filters-1)   

   !write(*,*) Grid_nodes_means(aa,mm,ii,:)
   !write(*,*) covariances(ii,1,:)
   !write(*,*) covariances(ii,1,filters_selected_index(1):filters_selected_index(1)+number_filters-1)
   !write(*,*)'flag 1', aa,mm
   !write(*,*) filters_selected_index(1),filters_selected_index(1)+number_filters-1
   !write(*,*) Grid_nodes_covariances(aa,mm,ii,1,1),covariances(ii,1,1)
   !read(*,*)

    !Grid_nodes_covariances(aa,mm,ii,1:number_filters,1:number_filters) = covariances(ii,                   &
    !  & filters_selected_index(1):filters_selected_index(1)+number_filters-1,  &
    !  & filters_selected_index(1):filters_selected_index(1)+number_filters-1) 

    Grid_nodes_covariances(aa,mm,ii,1,1) = covariances(ii,1,1) 

   !write(*,*)'flag 2', aa,mm
   enddo
   Grid_nodes_weights(aa,mm,:)           = weights(:)

  Enddo		
  write(*,*) 'Loading Age ', age, ' performed'
 Enddo    	

 write(*,*) '--------------------------------------------------------'
 write(*,*) 'Grid loaded'
 write(*,*) '--------------------------------------------------------'
 write(*,*)


read(*,*)


 end program
